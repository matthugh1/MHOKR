# Cycle Management User Stories

**Created:** 2025-01-XX  
**Purpose:** User stories for improving cycle management functionality, including support for managing both standard and custom cycles.

---

## 0. Current State (Baseline)

### 0.1 Cycle Types

**Standard Cycles:**
- Auto-generated cycles (months, quarters, years) created on-demand
- Created automatically when users select them in OKR forms via `StandardCycleSelector`
- Marked with `isStandard: true` in database
- Created with `status: 'DRAFT'` by default
- Generated by `CycleGeneratorService.getOrCreateStandardCycle()`
- Currently **not visible** in admin cycle management UI (filtered out on line 144 of `apps/web/src/app/admin/cycles/page.tsx`)

**Custom Cycles:**
- Manually created cycles for special periods (sprints, programs, ad-hoc periods)
- Created via admin UI at `/admin/cycles`
- Marked with `isStandard: false` in database
- Can be created with `status: 'DRAFT'` or `'ACTIVE'`
- **Fully manageable** in admin UI (edit, lock, archive, delete)

### 0.2 Current Limitations

1. **Standard cycles cannot be managed:**
   - Admin UI filters out standard cycles (`!cycle.isStandard`)
   - No way to change status of standard cycles (e.g., activate Q1 2026 from DRAFT to ACTIVE)
   - No way to lock or archive standard cycles
   - Standard cycles are created on-demand and remain in DRAFT status indefinitely

2. **Status transition UX issues:**
   - Edit dialog allows selecting invalid status transitions (backend rejects, but user sees error)
   - No dedicated "Activate" button for DRAFT â†’ ACTIVE transition
   - Lock/Archive buttons use different endpoint than Edit (`/status` vs `/cycles/:id`)
   - No frontend validation of valid status transitions

3. **Missing cycle lifecycle management:**
   - No bulk operations (activate all Q1 cycles, archive all past quarters)
   - No cycle status filtering in admin UI
   - No visual indicators of cycle lifecycle stage

---

## 1. User Stories

### US-CYCLE-001: Manage Standard Cycles

**As a** Tenant Administrator  
**I want to** view and manage standard cycles (months, quarters, years) in the admin UI  
**So that** I can activate, lock, and archive standard cycles just like custom cycles

**Acceptance Criteria:**
- [ ] Admin cycle management page shows both standard and custom cycles
- [ ] Standard cycles are visually distinguished (e.g., badge or icon indicator)
- [ ] Standard cycles can be edited (name, dates, status) - with appropriate restrictions
- [ ] Standard cycles can be locked and archived
- [ ] Standard cycles cannot be deleted (only custom cycles can be deleted)
- [ ] Standard cycles can be filtered separately from custom cycles
- [ ] Standard cycles show their type (Month, Quarter, Year) in addition to name

**Technical Notes:**
- Remove filter `!cycle.isStandard` from `loadCycles()` in `apps/web/src/app/admin/cycles/page.tsx`
- Add visual indicator (badge/icon) to distinguish standard vs custom
- Backend already supports updating standard cycles (no changes needed)
- Prevent deletion of standard cycles in UI (backend should also enforce this)

---

### US-CYCLE-002: Activate Cycle Action

**As a** Tenant Administrator  
**I want to** activate a DRAFT cycle with a single click  
**So that** I can quickly transition cycles from planning to active status

**Acceptance Criteria:**
- [ ] "Activate" button appears for cycles with status DRAFT
- [ ] Button is prominently placed (next to Edit button)
- [ ] Clicking activates the cycle (DRAFT â†’ ACTIVE)
- [ ] Confirmation dialog explains what activation means
- [ ] Success toast confirms activation
- [ ] Button disappears after activation (cycle is now ACTIVE)

**Technical Notes:**
- Add `handleActivateCycle()` function similar to `handleLockCycle()`
- Use `PATCH /okr/cycles/:id/status` endpoint with `status: 'ACTIVE'`
- Show confirmation dialog: "Activating this cycle will make it available for OKR creation. Are you sure?"
- Status transition validation handled by backend

---

### US-CYCLE-003: Status Transition Validation

**As a** Tenant Administrator  
**I want to** see only valid status transitions in the edit dialog  
**So that** I don't attempt invalid transitions and see error messages

**Acceptance Criteria:**
- [ ] Edit dialog status dropdown shows only valid next statuses
- [ ] Current status is clearly displayed
- [ ] Invalid statuses are disabled/grayed out in dropdown
- [ ] Tooltip explains why certain statuses are disabled
- [ ] Status transition rules are clearly communicated:
  - DRAFT â†’ ACTIVE (only)
  - ACTIVE â†’ LOCKED (only)
  - LOCKED â†’ ARCHIVED (only)
  - ARCHIVED â†’ (no transitions allowed)

**Technical Notes:**
- Create helper function `getValidNextStatuses(currentStatus: string): string[]`
- Filter dropdown options based on current status
- Add tooltip/help text explaining transition rules
- Backend validation remains as safety net

---

### US-CYCLE-004: Cycle Status Filtering

**As a** Tenant Administrator  
**I want to** filter cycles by status (DRAFT, ACTIVE, LOCKED, ARCHIVED)  
**So that** I can quickly find cycles in specific lifecycle stages

**Acceptance Criteria:**
- [ ] Filter dropdown/chips added above cycle table
- [ ] Filter options: All, DRAFT, ACTIVE, LOCKED, ARCHIVED
- [ ] Filter persists across page reloads (URL query param)
- [ ] Active filter is visually highlighted
- [ ] Filter shows count of cycles in each status
- [ ] "All" option shows total count

**Technical Notes:**
- Add status filter state and UI controls
- Filter cycles client-side (already loaded)
- Optionally add backend filtering for performance (if many cycles exist)
- Use URL query params for filter state: `?status=ACTIVE`

---

### US-CYCLE-005: Cycle Lifecycle Indicators

**As a** Tenant Administrator  
**I want to** see visual indicators of cycle lifecycle status  
**So that** I can quickly understand the state of each cycle

**Acceptance Criteria:**
- [ ] Status badges use color coding:
  - DRAFT: Gray/outline (planning phase)
  - ACTIVE: Green/primary (currently active)
  - LOCKED: Yellow/warning (locked for edits)
  - ARCHIVED: Muted/secondary (historical)
- [ ] Cycle table shows status column with colored badges
- [ ] Active cycle banner on OKR page shows cycle status
- [ ] Locked/archived cycles show warning icon in cycle selector

**Technical Notes:**
- Enhance `getStatusBadgeVariant()` function with better color mapping
- Add status icons (Lock icon for LOCKED, Archive icon for ARCHIVED)
- Ensure consistency across admin UI and OKR page

---

### US-CYCLE-006: Prevent Standard Cycle Deletion

**As a** System Administrator  
**I want to** prevent deletion of standard cycles  
**So that** users cannot accidentally delete auto-generated cycles

**Acceptance Criteria:**
- [ ] Delete button hidden for standard cycles in admin UI
- [ ] Backend API rejects deletion attempts for standard cycles
- [ ] Error message explains why standard cycles cannot be deleted
- [ ] Standard cycles can only be archived (not deleted)

**Technical Notes:**
- Add check in `delete()` method: `if (cycle.isStandard) throw BadRequestException`
- Hide delete button in UI for standard cycles
- Update delete confirmation dialog to exclude standard cycles

---

### US-CYCLE-007: Standard Cycle Bulk Operations

**As a** Tenant Administrator  
**I want to** activate multiple standard cycles at once  
**So that** I can efficiently set up quarterly cycles for the year

**Acceptance Criteria:**
- [ ] Checkbox selection for cycles (multi-select)
- [ ] Bulk action dropdown: "Activate Selected", "Lock Selected", "Archive Selected"
- [ ] Bulk operations show confirmation dialog with count
- [ ] Bulk operations validate all transitions are valid before executing
- [ ] Progress indicator during bulk operations
- [ ] Success/error summary after bulk operation completes

**Technical Notes:**
- Add checkbox column to cycle table
- Create bulk action component
- Add backend endpoint: `POST /okr/cycles/bulk-status` with `{ cycleIds: string[], status: string }`
- Validate transitions for all cycles before executing
- Show per-cycle errors if some fail

---

### US-CYCLE-008: Cycle Status Summary Dashboard

**As a** Tenant Administrator  
**I want to** see a summary of cycle statuses at a glance  
**So that** I can quickly understand the state of all cycles

**Acceptance Criteria:**
- [ ] Summary cards showing counts: DRAFT (X), ACTIVE (Y), LOCKED (Z), ARCHIVED (W)
- [ ] Cards are clickable filters (click DRAFT card â†’ filter to DRAFT cycles)
- [ ] Total cycles count displayed
- [ ] Visual breakdown (pie chart or bar chart) optional
- [ ] Summary updates when cycles are modified

**Technical Notes:**
- Add summary section above cycle table
- Calculate counts from loaded cycles
- Use existing UI card components
- Make cards clickable to filter

---

### US-CYCLE-009: Cycle Status Transition Help Text

**As a** Tenant Administrator  
**I want to** understand what each status transition means  
**So that** I make informed decisions about cycle lifecycle

**Acceptance Criteria:**
- [ ] Help tooltip/icon next to status dropdown
- [ ] Explanation of each status:
  - **DRAFT**: Planning phase. OKRs can be freely edited.
  - **ACTIVE**: Cycle is live. Normal edit rules apply.
  - **LOCKED**: Only admins can edit OKRs. Prevents mid-cycle changes.
  - **ARCHIVED**: Read-only. Historical record. Cannot be modified.
- [ ] Transition rules clearly explained:
  - DRAFT â†’ ACTIVE: Start the cycle
  - ACTIVE â†’ LOCKED: Freeze changes (only admins can edit)
  - LOCKED â†’ ARCHIVED: Mark cycle as complete (final state)
- [ ] Help text accessible via "?" icon or info tooltip

**Technical Notes:**
- Add `InfoTooltip` component with status explanations
- Include transition rules in help text
- Add to both Edit dialog and Lock/Archive confirmation dialogs

---

### US-CYCLE-010: Consistent Status Update Endpoints

**As a** Developer  
**I want to** use consistent API endpoints for status updates  
**So that** the codebase is maintainable and predictable

**Acceptance Criteria:**
- [ ] All status updates use `PATCH /okr/cycles/:id/status` endpoint
- [ ] Edit dialog also uses status endpoint (not general update endpoint)
- [ ] General update endpoint (`PATCH /okr/cycles/:id`) no longer accepts status field
- [ ] API documentation reflects this pattern
- [ ] Frontend code uses consistent pattern for all status updates

**Technical Notes:**
- Refactor `handleSaveEdit()` to use status endpoint when only status changes
- Consider splitting: if only status changes â†’ use `/status` endpoint, else use general update
- Update API contract documentation
- Ensure backward compatibility during transition

---

## 2. Implementation Priority

### Phase 1: Core Functionality (Must Have)
1. **US-CYCLE-001**: Manage Standard Cycles
2. **US-CYCLE-002**: Activate Cycle Action
3. **US-CYCLE-003**: Status Transition Validation
4. **US-CYCLE-006**: Prevent Standard Cycle Deletion

### Phase 2: UX Improvements (Should Have)
5. **US-CYCLE-004**: Cycle Status Filtering
6. **US-CYCLE-005**: Cycle Lifecycle Indicators
7. **US-CYCLE-009**: Cycle Status Transition Help Text

### Phase 3: Advanced Features (Nice to Have)
8. **US-CYCLE-007**: Standard Cycle Bulk Operations
9. **US-CYCLE-008**: Cycle Status Summary Dashboard
10. **US-CYCLE-010**: Consistent Status Update Endpoints

---

## 3. Technical Considerations

### 3.1 Backend Changes Required

- **Prevent Standard Cycle Deletion**: Add check in `OkrCycleService.delete()` method
- **Bulk Status Update Endpoint**: New endpoint `POST /okr/cycles/bulk-status` (if implementing US-CYCLE-007)
- **Status Transition Validation**: Already exists, but ensure error messages are clear

### 3.2 Frontend Changes Required

- **Remove Standard Cycle Filter**: Update `loadCycles()` to show all cycles
- **Add Visual Indicators**: Standard vs custom badge, status badges with colors
- **Status Transition Helper**: Create `getValidNextStatuses()` utility function
- **Filter UI**: Add status filter dropdown/chips
- **Bulk Selection**: Add checkbox column and bulk actions (if implementing US-CYCLE-007)

### 3.3 Database Considerations

- No schema changes required
- `isStandard` field already exists
- `status` field already exists with proper enum

### 3.4 Testing Requirements

- [ ] Unit tests for status transition validation
- [ ] Integration tests for standard cycle management
- [ ] E2E tests for activate/lock/archive flows
- [ ] Test that standard cycles cannot be deleted
- [ ] Test bulk operations (if implemented)

---

## 4. Open Questions

1. **Should standard cycles be editable?**
   - Allow editing name? (Currently auto-generated: "Q1 2026", "January 2026")
   - Allow editing dates? (Currently auto-calculated from month/quarter/year)
   - **Recommendation**: Allow status changes, but restrict name/date edits for standard cycles

2. **Should archived cycles appear in OKR creation dropdowns?**
   - Currently archived cycles are likely filtered out
   - **Recommendation**: Keep archived cycles hidden from creation dropdowns, but visible in admin UI

3. **Should there be a limit on number of ACTIVE cycles?**
   - Multiple active cycles could cause confusion
   - **Recommendation**: Allow multiple active cycles (some orgs may have overlapping cycles)

4. **Should cycle status transitions be audited?**
   - Track who activated/locked/archived cycles
   - **Recommendation**: Yes, add audit log entries for status changes

---

## 5. Related Documentation

- `services/core-api/prisma/schema.prisma` - Cycle model definition
- `services/core-api/src/modules/okr/okr-cycle.service.ts` - Cycle service logic
- `apps/web/src/app/admin/cycles/page.tsx` - Admin UI implementation
- `docs/planning/OKR_TAXONOMY_DECISIONS.md` - Cycle taxonomy definitions

---

**Status**: ðŸ“‹ Ready for Implementation  
**Next Steps**: Prioritize stories, assign to sprint, begin Phase 1 implementation

